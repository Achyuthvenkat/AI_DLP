{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">AI SECURITY EVENT DASHBPARD</h1>

<!-- Back Button -->
<a href="javascript:history.back()" class="btn btn-secondary mb-3">← Back</a>

<!-- Filter Section -->
<form method="GET" action="{{ url_for('dashboard') }}" class="mb-4">
    <div class="row g-3">
        <div class="col-md-2">
            <label for="ai_filter" class="form-label">AI Classification:</label>
            <select name="ai_filter" id="ai_filter" class="form-select">
                <option value="">All AI Classifications</option>
                {% for label in ai_labels %}
                <option value="{{ label }}" {% if current_ai_filter == label %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="sklearn_filter" class="form-label">Sklearn Classification:</label>
            <select name="sklearn_filter" id="sklearn_filter" class="form-select">
                <option value="">All Sklearn Classifications</option>
                {% for label in sklearn_labels %}
                <option value="{{ label }}" {% if current_sklearn_filter == label %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="device_filter" class="form-label">Device:</label>
            <select name="device_filter" id="device_filter" class="form-select">
                <option value="">All Devices</option>
                {% for device in devices %}
                <option value="{{ device }}" {% if current_device_filter == device %}selected{% endif %}>{{ device }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="event_type_filter" class="form-label">Event Type:</label>
            <select name="event_type_filter" id="event_type_filter" class="form-select">
                <option value="">All Types</option>
                {% for event_type in event_types %}
                <option value="{{ event_type }}" {% if current_event_type_filter == event_type %}selected{% endif %}>{{ event_type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="user_filter" class="form-label">User Email:</label>
            <input type="text" name="user_filter" id="user_filter" class="form-control" 
                   placeholder="Search user email..." value="{{ current_user_filter }}">
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Clear Filters</a>
        </div>
    </div>
    <!-- Hidden field to maintain current page when filtering -->
    <input type="hidden" name="page" value="1">
</form>

<!-- Filter Status -->
{% if current_ai_filter or current_sklearn_filter or current_device_filter or current_event_type_filter or current_user_filter %}
<div class="alert alert-info">
    <strong>Active Filters:</strong>
    {% if current_ai_filter %}<span class="badge bg-primary me-1">AI: {{ current_ai_filter }}</span>{% endif %}
    {% if current_sklearn_filter %}<span class="badge bg-info me-1">Sklearn: {{ current_sklearn_filter }}</span>{% endif %}
    {% if current_device_filter %}<span class="badge bg-secondary me-1">Device: {{ current_device_filter }}</span>{% endif %}
    {% if current_event_type_filter %}<span class="badge bg-success me-1">Type: {{ current_event_type_filter }}</span>{% endif %}
    {% if current_user_filter %}<span class="badge bg-warning me-1">User: {{ current_user_filter }}</span>{% endif %}
    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary ms-2">Clear All</a>
</div>
{% endif %}

<!-- Events Table -->
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Time</th>
                <th>Device</th>
                <th>User</th>
                <th>Event Type</th>
                <th>Target</th>
                <th>Snippet</th>
                <th>Policy</th>
                <th>AI Classification</th>
                <th>Sklearn Classification</th>
                <th>Agreement</th>
            </tr>
        </thead>
        <tbody>
            {% for e in events %}
            <tr>
                <td>{{ e.created_at }}</td>
                <td>{{ e.device_id }}</td>
                <td>{{ e.user_email }}</td>
                <td>
                    <span class="badge bg-primary">{{ e.event_type }}</span>
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 150px;" title="{{ e.target }}">
                        {{ e.target }}
                    </div>
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 200px;" title="{{ e.snippet }}">
                        {{ e.snippet }}
                    </div>
                </td>
                <td>{{ e.policy_id or 'N/A' }}</td>
                <td>
                    {% if e.ai_label %}
                        <span class="badge {% if e.ai_label == 'Confidential' %}bg-danger{% elif e.ai_label == 'Sensitive' %}bg-warning{% elif e.ai_label == 'Public' %}bg-success{% else %}bg-primary{% endif %}">
                            {{ e.ai_label }}
                        </span>
                        {% if e.ai_confidence %}
                            <br><small class="text-muted">{{ "%.1f"|format(e.ai_confidence * 100) }}%</small>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if e.sklearn_label %}
                        <span class="badge {% if e.sklearn_label == 'Confidential' %}bg-danger{% elif e.sklearn_label == 'Sensitive' %}bg-warning{% elif e.sklearn_label == 'Public' %}bg-success{% else %}bg-primary{% endif %}">
                            {{ e.sklearn_label }}
                        </span>
                        {% if e.sklearn_confidence %}
                            <br><small class="text-muted">{{ "%.1f"|format(e.sklearn_confidence * 100) }}%</small>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if e.ai_label and e.sklearn_label %}
                        {% if e.ai_label == e.sklearn_label %}
                            <span class="badge bg-success">✓ Match</span>
                        {% else %}
                            <span class="badge bg-warning">✗ Differ</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" class="text-center">No events found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Dashboard pagination">
    <ul class="pagination justify-content-center">
        {% set filter_params = [] %}
        {% if current_ai_filter %}{% set _ = filter_params.append(('ai_filter', current_ai_filter)) %}{% endif %}
        {% if current_sklearn_filter %}{% set _ = filter_params.append(('sklearn_filter', current_sklearn_filter)) %}{% endif %}
        {% if current_device_filter %}{% set _ = filter_params.append(('device_filter', current_device_filter)) %}{% endif %}
        {% if current_event_type_filter %}{% set _ = filter_params.append(('event_type_filter', current_event_type_filter)) %}{% endif %}
        {% if current_user_filter %}{% set _ = filter_params.append(('user_filter', current_user_filter)) %}{% endif %}
        
        {% if has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('dashboard', page=1, **dict(filter_params)) }}">First</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('dashboard', page=prev_page, **dict(filter_params)) }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">First</span>
        </li>
        <li class="page-item disabled">
            <span class="page-link">Previous</span>
        </li>
        {% endif %}
        
        <!-- Page numbers -->
        {% set start_page = [1, current_page - 2] | max %}
        {% set end_page = [total_pages, current_page + 2] | min %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        <li class="page-item {% if page_num == current_page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('dashboard', page=page_num, **dict(filter_params)) }}">{{ page_num }}</a>
        </li>
        {% endfor %}
        
        {% if has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('dashboard', page=next_page, **dict(filter_params)) }}">Next</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('dashboard', page=total_pages, **dict(filter_params)) }}">Last</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">Next</span>
        </li>
        <li class="page-item disabled">
            <span class="page-link">Last</span>
        </li>
        {% endif %}
    </ul>
</nav>

<div class="text-center mt-2">
    <small class="text-muted">
        Showing page {{ current_page }} of {{ total_pages }} 
        ({{ events|length }} events on this page, {{ total_events }} total)
        {% if current_ai_filter or current_sklearn_filter or current_device_filter or current_event_type_filter or current_user_filter %}
        - Filtered Results
        {% endif %}
    </small>
</div>
{% endif %}

<!-- Dual Classification Charts -->
<div class="row mt-5">
    <div class="col-md-6">
        <h3>AI Classification Distribution</h3>
        <canvas id="aiClassificationChart" width="400" height="300"></canvas>
    </div>
    <div class="col-md-6">
        <h3>Sklearn Classification Distribution</h3>
        <canvas id="sklearnClassificationChart" width="400" height="300"></canvas>
    </div>
</div>

<!-- Model Comparison Section -->
<div class="row mt-4">
    <div class="col-md-8">
        <h3>Model Agreement Analysis</h3>
        <canvas id="agreementChart" width="400" height="200"></canvas>
    </div>
    <div class="col-md-4">
        <h4>Classification Stats</h4>
        <div class="card">
            <div class="card-body">
                <p><strong>Total Events:</strong> {{ total_events }}</p>
                <p><strong>Current Page:</strong> {{ current_page }} of {{ total_pages }}</p>
                <p><strong>Events on Page:</strong> {{ events|length }}</p>
                {% if current_ai_filter or current_sklearn_filter or current_device_filter or current_event_type_filter or current_user_filter %}
                <p><small class="text-muted">Results are filtered</small></p>
                {% endif %}
                
                <!-- Agreement metrics -->
                {% set agreement_count = 0 %}
                {% set total_classified = 0 %}
                {% for e in events %}
                    {% if e.ai_label and e.sklearn_label %}
                        {% set total_classified = total_classified + 1 %}
                        {% if e.ai_label == e.sklearn_label %}
                            {% set agreement_count = agreement_count + 1 %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
                
                {% if total_classified > 0 %}
                <hr>
                <p><strong>Model Agreement:</strong></p>
                <p>{{ agreement_count }} / {{ total_classified }} 
                   ({{ "%.1f"|format((agreement_count / total_classified) * 100) }}%)</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Enhanced Chart JavaScript -->
<script>
    // Chart Data
    const aiLabels = {{ ai_chart_labels|safe }};
    const aiValues = {{ ai_chart_values|safe }};
    const sklearnLabels = {{ sklearn_chart_labels|safe }};
    const sklearnValues = {{ sklearn_chart_values|safe }};
    
    const labelColorMap = {
        'Confidential': '#dc3545', // Red
        'Sensitive': '#ffc107', // Yellow
        'Public': '#28a745', // Green
        'Internal': '#007bff' // Blue
    };

    function getColors(labels) {
        return labels.map(label => labelColorMap[label] || '#999999'); // Default to blue if not found
    }

    // AI Classification Chart
    if (aiLabels.length > 0 && aiValues.length > 0) {
        const aiCtx = document.getElementById('aiClassificationChart').getContext('2d');
        new Chart(aiCtx, {
            type: 'doughnut',
            data: {
                labels: aiLabels,
                datasets: [{
                    data: aiValues,
                    backgroundColor: getColors(aiLabels),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'AI Model Classifications'
                    }
                }
            }
        });
    } else {
        document.getElementById('aiClassificationChart').style.display = 'none';
        document.querySelector('.col-md-6:first-child h3').innerHTML = '<em>No AI classification data available</em>';
    }

    // Sklearn Classification Chart
    if (sklearnLabels.length > 0 && sklearnValues.length > 0) {
        const sklearnCtx = document.getElementById('sklearnClassificationChart').getContext('2d');
        new Chart(sklearnCtx, {
            type: 'doughnut',
            data: {
                labels: sklearnLabels,
                datasets: [{
                    data: sklearnValues,
                    backgroundColor: getColors(sklearnLabels),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Sklearn Model Classifications'
                    }
                }
            }
        });
    } else {
        document.getElementById('sklearnClassificationChart').style.display = 'none';
        document.querySelector('.col-md-6:last-child h3').innerHTML = '<em>No sklearn classification data available</em>';
    }

    // Model Agreement Chart
    const agreementCtx = document.getElementById('agreementChart').getContext('2d');
    
    // Calculate agreement data from current page events
    let agreementData = { match: 0, differ: 0, partial: 0 };
    {% for e in events %}
        {% if e.ai_label and e.sklearn_label %}
            {% if e.ai_label == e.sklearn_label %}
                agreementData.match++;
            {% else %}
                agreementData.differ++;
            {% endif %}
        {% else %}
            agreementData.partial++;
        {% endif %}
    {% endfor %}

    new Chart(agreementCtx, {
        type: 'bar',
        data: {
            labels: ['Models Agree', 'Models Disagree', 'Partial Classification'],
            datasets: [{
                label: 'Event Count',
                data: [agreementData.match, agreementData.differ, agreementData.partial],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'AI vs Sklearn Model Agreement (Current Page)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
</script>
{% endblock %}